<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Spray Marks – TMD Selector (PWA)</title>

<!-- PWA meta -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --bg:#0f172a; --panel:#111827; --accent:#22c55e; --accent2:#f59e0b;
    --text:#e5e7eb; --muted:#9ca3af; --btn:#1f2937; --danger:#ef4444; --blue:#38bdf8;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--text);}
  header{padding:16px 20px; background:linear-gradient(90deg,#0f172a,#111827); border-bottom:1px solid #1f2937; position:sticky; top:0; z-index:10;}
  h1{margin:0; font-size:20px; letter-spacing:.2px}
  main{max-width:980px; margin:18px auto; padding:0 16px 40px;}
  .row{display:flex; gap:16px; flex-wrap:wrap;}
  .card{background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px;}
  .w2{flex:2 1 520px}
  .w1{flex:1 1 320px}
  .muted{color:var(--muted); font-size:13px}
  .question{font-size:18px; margin:0 0 12px}
  .options{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px}
  button.opt{background:var(--btn); color:var(--text); border:1px solid #374151; border-radius:10px; padding:12px 14px; font-size:15px; cursor:pointer; transition:all .12s ease}
  button.opt:hover{border-color:var(--blue); transform:translateY(-1px)}
  .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; color:var(--muted); font-size:12px; margin-right:6px; margin-bottom:6px}
  .breadcrumbs{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
  .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
  .btn{background:#0b1220; color:var(--text); border:1px solid #374151; border-radius:10px; padding:10px 12px; cursor:pointer}
  .btn.attn{border-color:var(--accent); color:#d1fae5}
  .btn.warn{border-color:var(--accent2); color:#fff}
  .result{border-left:4px solid var(--accent);}
  .result h2{margin:0 0 8px}
  .table{width:100%; border-collapse:collapse; margin-top:8px}
  .table th,.table td{border:1px solid #374151; padding:8px; text-align:left}
  details{background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:10px 12px}
  details summary{cursor:pointer; color:#93c5fd}
  textarea{width:100%; min-height:260px; background:#0b1220; color:#e5e7eb; border:1px solid #374151; border-radius:10px; padding:10px; font-family:ui-monospace,Consolas,Menlo,monospace; font-size:13px}
  .badge{padding:2px 8px; border-radius:8px; font-size:12px; border:1px solid #334155; color:#cbd5e1}
  .badge.hg{border-color:#64748b}
  .foot{margin-top:8px; font-size:12px; color:#94a3b8}
  a.link{color:#93c5fd; text-decoration:none}
</style>
</head>
<body>
<header><h1>Spray Marks NZ Ltd — TMD Selector (GTTM)</h1></header>
<main>
  <div class="row">
    <section class="card w2" id="qpanel">
      <div class="muted">Follow the prompts. Your choices map to a recommended TMD.</div>
      <h2 class="question" id="qtext">Loading…</h2>
      <div class="options" id="opts"></div>
      <div class="breadcrumbs" id="crumbs"></div>
      <div class="actions">
        <button class="btn" onclick="goBack()">⬅ Back</button>
        <button class="btn" onclick="resetFlow()">Reset</button>
        <button class="btn attn" onclick="copySummary()">Copy summary</button>
        <span class="badge hg" id="ver"></span>
      </div>
    </section>

    <aside class="card w1 result" id="rpanel" style="display:none">
      <h2 id="rtitle">Recommended TMD</h2>
      <div id="rbody"></div>
      <table class="table" id="rtab" style="display:none"></table>
      <div class="foot">Tip: add this to your Home Screen for full-screen app mode.</div>
    </aside>
  </div>

  <details class="card">
    <summary>Admin: edit rules / TMD library (local only)</summary>
    <p class="muted">Edit the JSON below and <b>Save</b>. Stored locally in this device (offline-capable). <b>Restore defaults</b> to revert.</p>
    <div class="actions">
      <button class="btn attn" onclick="saveEdits()">Save</button>
      <button class="btn warn" onclick="restoreDefaults()">Restore defaults</button>
    </div>
    <textarea id="editor"></textarea>
  </details>
</main>

<script>
// Register service worker
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(console.error);
  });
}

// Default rule set & TMD library
const DEFAULT_DATA = {
  version: "SMNZL Rules v1.0 (PWA)",
  nodes: [
    { id:"Q0", text:"Which Work Category applies?", options:[
      {label:"CAT A (L1 & L2 roads)", next:"Q_A_Level"},
      {label:"CAT B (L1 & L2 roads)", next:"Q_B_Level"},
      {label:"CAT C (Level 3 only)", next:"Q_C_Level3"}
    ]},
    { id:"Q_A_Level", text:"CAT A: Road speed environment?", options:[
      {label:"Level 1 (≤ 60 km/h)", next:"Q_A_L1_Dist"},
      {label:"Level 2 (> 60 km/h)", next:"Q_A_L2_Dist"}
    ]},
    { id:"Q_A_L1_Dist", text:"CAT A – Level 1: Distance from live traffic?", options:[
      {label:"≤ 1 m", next:"Q_A_L1_Peds"},
      {label:"1–2 m", next:"Q_A_L1_Peds"},
      {label:"2–5 m", next:"Q_A_L1_Peds"},
      {label:"> 5 m", next:"Q_A_L1_Peds"}
    ]},
    { id:"Q_A_L1_Peds", text:"Workers or pedestrians on foot?", options:[
      {label:"Yes", next:"Q_A_L1_CSD"},
      {label:"No", next:"Q_A_L1_CSD"}
    ]},
    { id:"Q_A_L1_CSD", text:"Forward CSD available / static signs installed?", options:[
      {label:"Yes", result:"TMD_A_L1_YES"},
      {label:"No", result:"TMD_A_L1_NO"}
    ]},
    { id:"Q_A_L2_Dist", text:"CAT A – Level 2: Distance from live traffic?", options:[
      {label:"≤ 1 m", next:"Q_A_L2_Peds"},
      {label:"1–2 m", next:"Q_A_L2_Peds"},
      {label:"2–5 m", next:"Q_A_L2_Peds"},
      {label:"> 5 m", next:"Q_A_L2_Peds"}
    ]},
    { id:"Q_A_L2_Peds", text:"Workers or pedestrians on foot?", options:[
      {label:"Yes", next:"Q_A_L2_CSD"},
      {label:"No", next:"Q_A_L2_CSD"}
    ]},
    { id:"Q_A_L2_CSD", text:"Forward CSD available / static signs installed?", options:[
      {label:"Yes", result:"TMD_A_L2_YES"},
      {label:"No", result:"TMD_A_L2_NO"}
    ]},

    { id:"Q_B_Level", text:"CAT B: Road speed environment?", options:[
      {label:"Level 1 (≤ 60 km/h)", next:"Q_B_L1_Dist"},
      {label:"Level 2 (> 60 km/h)", next:"Q_B_L2_Dist"}
    ]},
    { id:"Q_B_L1_Dist", text:"CAT B – Level 1: Distance from live traffic?", options:[
      {label:"≤ 1 m", next:"Q_B_L1_Peds"},
      {label:"1–2 m", next:"Q_B_L1_Peds"},
      {label:"2–5 m", next:"Q_B_L1_Peds"},
      {label:"> 5 m", next:"Q_B_L1_Peds"}
    ]},
    { id:"Q_B_L1_Peds", text:"Workers or pedestrians on foot?", options:[
      {label:"Yes", next:"Q_B_L1_CSD"},
      {label:"No", next:"Q_B_L1_CSD"}
    ]},
    { id:"Q_B_L1_CSD", text:"Forward CSD available / static signs installed?", options:[
      {label:"Yes", result:"TMD_B_L1_YES"},
      {label:"No", result:"TMD_B_L1_NO"}
    ]},

    { id:"Q_B_L2_Dist", text:"CAT B – Level 2: Distance from live traffic?", options:[
      {label:"≤ 1 m", next:"Q_B_L2_Peds"},
      {label:"1–2 m", next:"Q_B_L2_Peds"},
      {label:"2–5 m", next:"Q_B_L2_Peds"},
      {label:"> 5 m", next:"Q_B_L2_Peds"}
    ]},
    { id:"Q_B_L2_Peds", text:"Workers or pedestrians on foot?", options:[
      {label:"Yes", next:"Q_B_L2_CSD"},
      {label:"No", next:"Q_B_L2_CSD"}
    ]},
    { id:"Q_B_L2_CSD", text:"Forward CSD available / static signs installed?", options:[
      {label:"Yes", result:"TMD_B_L2_YES"},
      {label:"No", result:"TMD_B_L2_NO"}
    ]},

    { id:"Q_C_Level3", text:"CAT C – Level 3 roads", options:[
      {label:"Workers on foot", next:"Q_C_L3_CSD"},
      {label:"No one on foot", next:"Q_C_L3_CSD"}
    ]},
    { id:"Q_C_L3_CSD", text:"Forward CSD available / static signs installed?", options:[
      {label:"Yes", result:"TMD_C_L3_YES"},
      {label:"No", result:"TMD_C_L3_NO"}
    ]}
  ],
  tmdLibrary: [
    { code:"TMD_A_L1_YES", name:"SMNZ A1 (L1) – CSD/static signs present", link:"#"},
    { code:"TMD_A_L1_NO",  name:"SMNZ A2 (L1) – No CSD/static signs", link:"#"},
    { code:"TMD_A_L2_YES", name:"SMNZ A3 (L2) – CSD/static signs present", link:"#"},
    { code:"TMD_A_L2_NO",  name:"SMNZ A4 (L2) – No CSD/static signs", link:"#"},
    { code:"TMD_B_L1_YES", name:"SMNZ B1 (L1) – CSD/static signs present", link:"#"},
    { code:"TMD_B_L1_NO",  name:"SMNZ B2 (L1) – No CSD/static signs", link:"#"},
    { code:"TMD_B_L2_YES", name:"SMNZ B3 (L2) – CSD/static signs present", link:"#"},
    { code:"TMD_B_L2_NO",  name:"SMNZ B4 (L2) – No CSD/static signs", link:"#"},
    { code:"TMD_C_L3_YES", name:"SMNZ C1 (L3) – CSD/static signs present", link:"#"},
    { code:"TMD_C_L3_NO",  name:"SMNZ C2 (L3) – No CSD/static signs", link:"#"},
    { code:"TMD_CATC_Level3", name:"SMNZ C0 (L3) – Default Level 3", link:"#"}
  ]
};

let RULES = JSON.parse(localStorage.getItem('smnzl_rules_pwa') || JSON.stringify(DEFAULT_DATA));
const historyStack = [];
let currentId = "Q0";
let resultCode = null;

function byId(id){ return RULES.nodes.find(n => n.id===id); }
function tmdBy(code){ return RULES.tmdLibrary.find(t => t.code===code); }

function render(){
  const q = byId(currentId);
  const qtext = document.getElementById('qtext');
  const opts = document.getElementById('opts');
  const crumbs = document.getElementById('crumbs');
  const rpanel = document.getElementById('rpanel');
  const ver = document.getElementById('ver');
  ver.textContent = RULES.version;

  if(!q){
    qtext.textContent = "Reached end of flow.";
    opts.innerHTML = "";
    return;
  }
  qtext.textContent = q.text;
  opts.innerHTML = "";
  q.options.forEach(opt => {
    const b = document.createElement('button');
    b.className = "opt";
    b.textContent = opt.label;
    b.onclick = () => {
      historyStack.push({id:currentId, label:opt.label, q: q.text});
      if(opt.result){
        resultCode = opt.result;
        showResult();
      }else{
        currentId = opt.next;
        resultCode = null;
        render();
      }
      drawCrumbs();
    };
    opts.appendChild(b);
  });

  function drawCrumbs(){
    crumbs.innerHTML = "";
    historyStack.forEach((h,i)=>{
      const span = document.createElement('span');
      span.className="pill";
      span.textContent = `${i+1}. ${h.label}`;
      crumbs.appendChild(span);
    });
  }
  drawCrumbs();
  if(!resultCode){ rpanel.style.display="none"; }
}

function showResult(){
  const r = tmdBy(resultCode) || {name: resultCode, link:"#"};
  const rpanel = document.getElementById('rpanel');
  const rbody = document.getElementById('rbody');
  const rtab = document.getElementById('rtab');
  rpanel.style.display = "block";
  rbody.innerHTML = `
    <div><span class="badge">Result code</span> <b>${resultCode}</b></div>
    <div style="margin-top:6px"><span class="badge">TMD</span> ${r.name}</div>
    <div style="margin-top:8px"><a class="link" href="${r.link}" target="_blank">Open diagram</a></div>
  `;
  rtab.style.display="none";
}

function goBack(){
  if(historyStack.length===0) return;
  historyStack.pop();
  resultCode = null;
  currentId = historyStack.length ? historyStack[historyStack.length-1].id : "Q0";
  render();
}

function resetFlow(){
  historyStack.length = 0;
  currentId = "Q0";
  resultCode = null;
  render();
}

function copySummary(){
  const lines = [];
  lines.push("Spray Marks – TMD Selector");
  lines.push(RULES.version);
  lines.push("");
  historyStack.forEach((h,i)=>lines.push(`${i+1}. ${h.q} -> ${h.label}`));
  if(resultCode){
    const r = tmdBy(resultCode) || {name: resultCode};
    lines.push("");
    lines.push(`Result: ${resultCode} – ${r.name}`);
  }
  navigator.clipboard.writeText(lines.join("\n")).then(()=>{
    alert("Summary copied to clipboard.");
  });
}

const editor = document.getElementById('editor');
function refreshEditor(){ editor.value = JSON.stringify(RULES,null,2); }
function saveEdits(){
  try{
    const obj = JSON.parse(editor.value);
    RULES = obj;
    localStorage.setItem('smnzl_rules_pwa', JSON.stringify(RULES));
    resetFlow();
    alert("Rules saved locally on this device.");
  }catch(e){
    alert("Invalid JSON. Not saved.\n"+e);
  }
}
function restoreDefaults(){
  RULES = JSON.parse(JSON.stringify(DEFAULT_DATA));
  localStorage.setItem('smnzl_rules_pwa', JSON.stringify(RULES));
  refreshEditor(); resetFlow();
}

refreshEditor();
render();
</script>
</body>
</html>
