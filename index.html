<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Spray Marks – TMD Selector (PWA)</title>

<!-- PWA meta -->
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<style>
  :root{
    --bg:#0f172a; --panel:#111827; --accent:#22c55e; --accent2:#f59e0b;
    --text:#e5e7eb; --muted:#9ca3af; --btn:#1f2937; --danger:#ef4444; --blue:#38bdf8;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial; background:var(--bg); color:var(--text);}
  header{padding:16px 20px; background:linear-gradient(90deg,#0f172a,#111827); border-bottom:1px solid #1f2937; position:sticky; top:0; z-index:10;}
  h1{margin:0; font-size:20px; letter-spacing:.2px}
  main{max-width:980px; margin:18px auto; padding:0 16px 40px;}
  .row{display:flex; gap:16px; flex-wrap:wrap;}
  .card{background:var(--panel); border:1px solid #1f2937; border-radius:12px; padding:16px;}
  .w2{flex:2 1 520px}
  .w1{flex:1 1 320px}
  .muted{color:var(--muted); font-size:13px}
  .question{font-size:18px; margin:0 0 12px}
  .options{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px}
  button.opt{background:var(--btn); color:var(--text); border:1px solid #374151; border-radius:10px; padding:12px 14px; font-size:15px; cursor:pointer; transition:all .12s ease}
  button.opt:hover{border-color:var(--blue); transform:translateY(-1px)}
  .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#0b1220; border:1px solid #1f2937; color:var(--muted); font-size:12px; margin-right:6px; margin-bottom:6px}
  .breadcrumbs{display:flex; gap:6px; flex-wrap:wrap; margin-top:6px}
  .actions{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap}
  .btn{background:#0b1220; color:var(--text); border:1px solid #374151; border-radius:10px; padding:10px 12px; cursor:pointer}
  .btn.attn{border-color:var(--accent); color:#d1fae5}
  .btn.warn{border-color:var(--accent2); color:#fff}
  .result{border-left:4px solid var(--accent);}
  .result h2{margin:0 0 8px}
  .table{width:100%; border-collapse:collapse; margin-top:8px}
  .table th,.table td{border:1px solid #374151; padding:8px; text-align:left}
  details{background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:10px 12px}
  details summary{cursor:pointer; color:#93c5fd}
  textarea{width:100%; min-height:260px; background:#0b1220; color:#e5e7eb; border:1px solid #374151; border-radius:10px; padding:10px; font-family:ui-monospace,Consolas,Menlo,monospace; font-size:13px}
  .badge{padding:2px 8px; border-radius:8px; font-size:12px; border:1px solid #334155; color:#cbd5e1}
  .badge.hg{border-color:#64748b}
  .foot{margin-top:8px; font-size:12px; color:#94a3b8}
  a.link{color:#93c5fd; text-decoration:none}
</style>
</head>
<body>
<header><h1>Spray Marks NZ Ltd — TMD Selector (GTTM)</h1></header>
<main>
  <div class="row">
    <section class="card w2" id="qpanel">
      <div class="muted">Follow the prompts. Your choices map to a recommended TMD.</div>
      <h2 class="question" id="qtext">Loading…</h2>
      <div class="options" id="opts"></div>
      <div class="breadcrumbs" id="crumbs"></div>
      <div class="actions">
        <button class="btn" onclick="goBack()">⬅ Back</button>
        <button class="btn" onclick="resetFlow()">Reset</button>
        <button class="btn attn" onclick="copySummary()">Copy summary</button>
        <span class="badge hg" id="ver"></span>
      </div>
    </section>

    <aside class="card w1 result" id="rpanel" style="display:none">
      <h2 id="rtitle">Recommended TMD</h2>
      <div id="rbody"></div>
      <table class="table" id="rtab" style="display:none"></table>
      <div class="foot">Tip: add this to your Home Screen for full-screen app mode.</div>
    </aside>
  </div>

  <details class="card">
    <summary>Admin: edit rules / TMD library (local only)</summary>
    <p class="muted">Edit the JSON below and <b>Save</b>. Stored locally in this device (offline-capable). <b>Restore defaults</b> to revert.</p>
    <div class="actions">
      <button class="btn attn" onclick="saveEdits()">Save</button>
      <button class="btn warn" onclick="restoreDefaults()">Restore defaults</button>
    </div>
    <textarea id="editor"></textarea>
  </details>
</main>

<script>
// Register service worker
if('serviceWorker' in navigator){
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('sw.js').catch(console.error);
  });
}

// Default rule set & TMD library
const DEFAULT_DATA = {
  "version": "SMNZL Rules (from Excel)",
  "nodes": [
    {
      "id": "Q0",
      "text": "What Road Category is it?",
      "options": [
        {
          "label": "CAT-A",
          "next": "CAT-A"
        },
        {
          "label": "CAT-B",
          "next": "CAT-B"
        },
        {
          "label": "CAT-C",
          "next": "CAT-C L3"
        }
      ]
    },
    {
      "id": "CAT-A",
      "text": "CAT-A: What Road Level is it ?",
      "options": [
        {
          "label": "Level 1",
          "next": "CAT-A L1"
        },
        {
          "label": "Level 2",
          "next": "CAT-A L2"
        }
      ]
    },
    {
      "id": "CAT-A L1",
      "text": "CAT-A L1: Where will your site be ?",
      "options": [
        {
          "label": "Berm (greater than 5m away from live lanes)",
          "result": "TMD ABL1.0: CAT-A/B L1 Offroad activity"
        },
        {
          "label": "Shoulder (no impact on live lanes)",
          "next": "CAT-A L1 Shoulder"
        },
        {
          "label": "Road (or close enough to impact the lanes",
          "next": "CAT-A L1 Lane"
        }
      ]
    },
    {
      "id": "CAT-A L1 Shoulder",
      "text": "CAT-A L1: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD AB1.1: CAT-A/B L1 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "result": "TMD AB1.2: CAT-A/B L1 Shoulder Closure"
        }
      ]
    },
    {
      "id": "CAT-A L1 Lane",
      "text": "CAT-A L1: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD AB1.1: CAT-A/B L1 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "next": "CAT-A L1 Lane Static"
        }
      ]
    },
    {
      "id": "CAT-A L1 Lane Static",
      "text": "CAT-A L1: Road will support 2 lanes",
      "options": [
        {
          "label": "Yes",
          "result": "TMD AB1.3:  CAT-A/B L1 Contraflow"
        },
        {
          "label": "No",
          "result": "TMD AB1.4:  CAT-A/B L1 Stop Go"
        }
      ]
    },
    {
      "id": "CAT-A L2",
      "text": "CAT-A L2: Where will your site be ?",
      "options": [
        {
          "label": "Berm (greater than 5m away from live lanes)",
          "result": "TMD ABC23.0: CAT-A/B/C L2/3 Offroad activity"
        },
        {
          "label": "Shoulder (no impact on live lanes)",
          "next": "CAT-A L2 Shoulder"
        },
        {
          "label": "Road (or close enough to impact the lanes",
          "next": "CAT-A L2 Lane"
        }
      ]
    },
    {
      "id": "CAT-A L2 Shoulder",
      "text": "CAT-A L2: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD ABC23.1: CAT-A/B/C L2/3 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "result": "TMD ABC23.2: CAT-A/B/C L2/3 Shoulder Closure"
        }
      ]
    },
    {
      "id": "CAT-A L2 Lane",
      "text": "CAT-A L2: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD ABC23.1: CAT-A/B/C L2/3 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "next": "CAT-A L2 Lane Static"
        }
      ]
    },
    {
      "id": "CAT-A L2 Lane Static",
      "text": "CAT-A L2: Road will support 2 lanes",
      "options": [
        {
          "label": "Yes",
          "result": "TMD ABC23.3:  CAT-A/B/C L2/3 Contraflow"
        },
        {
          "label": "No",
          "result": "TMD ABC23.4:  CAT-A/B/C L2/3 Stop Go"
        }
      ]
    },
    {
      "id": "CAT-B",
      "text": "CAT-B: What Road Level is it ?",
      "options": [
        {
          "label": "Level 1",
          "next": "CAT-B L1"
        },
        {
          "label": "Level 2",
          "next": "CAT-B L2"
        }
      ]
    },
    {
      "id": "CAT-B L1",
      "text": "CAT-B L1: Where will your site be ?",
      "options": [
        {
          "label": "Berm (greater than 5m away from live lanes)",
          "result": "TMD AB1.0: CAT-A/B L1 Offroad activity"
        },
        {
          "label": "Shoulder (no impact on live lanes)",
          "next": "CAT-B L1 Shoulder"
        },
        {
          "label": "Road (or close enough to impact the lanes",
          "next": "CAT-B L1 Lane"
        }
      ]
    },
    {
      "id": "CAT-B L1 Shoulder",
      "text": "CAT-B L1: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD AB1.1: CAT-A/B L1 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "result": "TMD AB1.2: CAT-A/B L1 Shoulder Closure"
        }
      ]
    },
    {
      "id": "CAT-B L1 Lane",
      "text": "CAT-B L1: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD AB1.1: CAT-A/B L1 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "next": "CAT-B L1 Lane Static"
        }
      ]
    },
    {
      "id": "CAT-B L1 Lane Static",
      "text": "CAT-B L1: Road will support 2 lanes",
      "options": [
        {
          "label": "Yes",
          "result": "TMD AB1.3:  CAT-A/B L1 Contraflow"
        },
        {
          "label": "No",
          "result": "TMD AB1.4:  CAT-A/B L1 Stop Go"
        }
      ]
    },
    {
      "id": "CAT-B L2",
      "text": "CAT-B L2: Where will your site be ?",
      "options": [
        {
          "label": "Berm (greater than 5m away from live lanes)",
          "result": "TMD ABC23.0: CAT-A/B/C L2/3 Offroad activity"
        },
        {
          "label": "Shoulder (no impact on live lanes)",
          "next": "CAT-B L2 Shoulder"
        },
        {
          "label": "Road (or close enough to impact the lanes",
          "next": "CAT-B L2 Lane"
        }
      ]
    },
    {
      "id": "CAT-B L2 Shoulder",
      "text": "CAT-B L2: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD ABC23.1: CAT-A/B/C L2/3 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "result": "TMD ABC23.2: CAT-A/B/C L2/3 Shoulder Closure"
        }
      ]
    },
    {
      "id": "CAT-B L2 Lane",
      "text": "CAT-B L2: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD ABC23.1: CAT-A/B/C L2/3 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "next": "CAT-B L2 Lane Static"
        }
      ]
    },
    {
      "id": "CAT-B L2 Lane Static",
      "text": "CAT-B L2: Road will support 2 lanes",
      "options": [
        {
          "label": "Yes",
          "result": "TMD ABC23.3:  CAT-A/B/C L2/3 Contraflow"
        },
        {
          "label": "No",
          "result": "TMD ABC23.4:  CAT-A/B/C L2/3 Stop Go"
        }
      ]
    },
    {
      "id": "CAT-C L3",
      "text": "CAT-C L3: Where will your site be ?",
      "options": [
        {
          "label": "Berm (greater than 5m away from live lanes)",
          "result": "TMD ABC23.0: CAT-A/B/C L/23 Offroad activity"
        },
        {
          "label": "Shoulder (no impact on live lanes)",
          "next": "CAT-C L3 Shoulder"
        },
        {
          "label": "Road (or close enough to impact the lanes",
          "next": "CAT-C L3 Lane"
        }
      ]
    },
    {
      "id": "CAT-C L3 Shoulder",
      "text": "CAT-C L3: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD ABC23.1: CAT-A/B/C L2/3 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "result": "TMD ABC23.2: CAT-A/B/C L2/3 Shoulder Closure"
        }
      ]
    },
    {
      "id": "CAT-C L3 Lane",
      "text": "CAT-C L3: Time on location",
      "options": [
        {
          "label": "less than 10min",
          "result": "TMD ABC23.1: CAT-A/B/C L2/3 Mobile Closure"
        },
        {
          "label": "more than 30min",
          "next": "CAT-C L3 Lane Static"
        }
      ]
    },
    {
      "id": "CAT-C L3 Lane Static",
      "text": "CAT-C L3: Road will support 2 lanes",
      "options": [
        {
          "label": "Yes",
          "result": "TMD ABC23.3:  CAT-A/B/C L2/3 Contraflow"
        },
        {
          "label": "No",
          "result": "TMD ABC23.4:  CAT-A/B/C L2/3 Stop Go"
        }
      ]
    }
  ],
  "tmdLibrary": [
    {
      "code": "TMD ABL1.0: CAT-A/B L1 Offroad activity",
      "name": "TMD ABL1.0: CAT-A/B L1 Offroad activity",
      "link": "ABCL23.0.png"
    },
    {
      "code": "TMD AB1.1: CAT-A/B L1 Mobile Closure",
      "name": "TMD AB1.1: CAT-A/B L1 Mobile Closure",
      "link": "#"
    },
    {
      "code": "TMD AB1.2: CAT-A/B L1 Shoulder Closure",
      "name": "TMD AB1.2: CAT-A/B L1 Shoulder Closure",
      "link": "#"
    },
    {
      "code": "TMD AB1.3:  CAT-A/B L1 Contraflow",
      "name": "TMD AB1.3:  CAT-A/B L1 Contraflow",
      "link": "#"
    },
    {
      "code": "TMD AB1.4:  CAT-A/B L1 Stop Go",
      "name": "TMD AB1.4:  CAT-A/B L1 Stop Go",
      "link": "#"
    },
    {
      "code": "TMD ABC23.0: CAT-A/B/C L2/3 Offroad activity",
      "name": "TMD ABC23.0: CAT-A/B/C L2/3 Offroad activity",
      "link": "#"
    },
    {
      "code": "TMD ABC23.1: CAT-A/B/C L2/3 Mobile Closure",
      "name": "TMD ABC23.1: CAT-A/B/C L2/3 Mobile Closure",
      "link": "#"
    },
    {
      "code": "TMD ABC23.2: CAT-A/B/C L2/3 Shoulder Closure",
      "name": "TMD ABC23.2: CAT-A/B/C L2/3 Shoulder Closure",
      "link": "#"
    },
    {
      "code": "TMD ABC23.3:  CAT-A/B/C L2/3 Contraflow",
      "name": "TMD ABC23.3:  CAT-A/B/C L2/3 Contraflow",
      "link": "#"
    },
    {
      "code": "TMD ABC23.4:  CAT-A/B/C L2/3 Stop Go",
      "name": "TMD ABC23.4:  CAT-A/B/C L2/3 Stop Go",
      "link": "#"
    },
  ]
};

let RULES = JSON.parse(localStorage.getItem('smnzl_rules_pwa') || JSON.stringify(DEFAULT_DATA));
const historyStack = [];
let currentId = "Q0";
let resultCode = null;

function byId(id){ return RULES.nodes.find(n => n.id===id); }
function tmdBy(code){ return RULES.tmdLibrary.find(t => t.code===code); }

function render(){
  const q = byId(currentId);
  const qtext = document.getElementById('qtext');
  const opts = document.getElementById('opts');
  const crumbs = document.getElementById('crumbs');
  const rpanel = document.getElementById('rpanel');
  const ver = document.getElementById('ver');
  ver.textContent = RULES.version;

  if(!q){
    qtext.textContent = "Reached end of flow.";
    opts.innerHTML = "";
    return;
  }
  qtext.textContent = q.text;
  opts.innerHTML = "";
  q.options.forEach(opt => {
    const b = document.createElement('button');
    b.className = "opt";
    b.textContent = opt.label;
    b.onclick = () => {
      historyStack.push({id:currentId, label:opt.label, q: q.text});
      if(opt.result){
        resultCode = opt.result;
        showResult();
      }else{
        currentId = opt.next;
        resultCode = null;
        render();
      }
      drawCrumbs();
    };
    opts.appendChild(b);
  });

  function drawCrumbs(){
    crumbs.innerHTML = "";
    historyStack.forEach((h,i)=>{
      const span = document.createElement('span');
      span.className="pill";
      span.textContent = `${i+1}. ${h.label}`;
      crumbs.appendChild(span);
    });
  }
  drawCrumbs();
  if(!resultCode){ rpanel.style.display="none"; }
}

function showResult(){
  const r = tmdBy(resultCode) || {name: resultCode, link:"#"};
  const rpanel = document.getElementById('rpanel');
  const rbody = document.getElementById('rbody');
  const rtab = document.getElementById('rtab');
  rpanel.style.display = "block";
  rbody.innerHTML = `
    <div><span class="badge">Result code</span> <b>${resultCode}</b></div>
    <div style="margin-top:6px"><span class="badge">TMD</span> ${r.name}</div>
    <div style="margin-top:8px"><a class="link" href="${r.link}" target="_blank">Open diagram</a></div>
  `;
  rtab.style.display="none";
}

function goBack(){
  if(historyStack.length===0) return;
  historyStack.pop();
  resultCode = null;
  currentId = historyStack.length ? historyStack[historyStack.length-1].id : "Q0";
  render();
}

function resetFlow(){
  historyStack.length = 0;
  currentId = "Q0";
  resultCode = null;
  render();
}

function copySummary(){
  const lines = [];
  lines.push("Spray Marks – TMD Selector");
  lines.push(RULES.version);
  lines.push("");
  historyStack.forEach((h,i)=>lines.push(`${i+1}. ${h.q} -> ${h.label}`));
  if(resultCode){
    const r = tmdBy(resultCode) || {name: resultCode};
    lines.push("");
    lines.push(`Result: ${resultCode} – ${r.name}`);
  }
  navigator.clipboard.writeText(lines.join("\n")).then(()=>{
    alert("Summary copied to clipboard.");
  });
}

const editor = document.getElementById('editor');
function refreshEditor(){ editor.value = JSON.stringify(RULES,null,2); }
function saveEdits(){
  try{
    const obj = JSON.parse(editor.value);
    RULES = obj;
    localStorage.setItem('smnzl_rules_pwa', JSON.stringify(RULES));
    resetFlow();
    alert("Rules saved locally on this device.");
  }catch(e){
    alert("Invalid JSON. Not saved.\n"+e);
  }
}
function restoreDefaults(){
  RULES = JSON.parse(JSON.stringify(DEFAULT_DATA));
  localStorage.setItem('smnzl_rules_pwa', JSON.stringify(RULES));
  refreshEditor(); resetFlow();
}

refreshEditor();
render();
</script>
</body>
</html>
